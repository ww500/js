<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        *{
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        #myCanvas{
            background-color: black;
        }
    </style>

</head>
<body>
    <canvas id="myCanvas" width="1000px" height="600px"></canvas>
    <script>
        const Canvas = document.querySelector("#myCanvas");
        const ctx = Canvas.getContext("2d");
        const canvasHeight = Canvas.height;
        const canvasWidth = Canvas.width;

        class Ball{
            constructor() {
                this.radius = 20;
                this.x = this.radius;
                this.y = this.radius;
                this.xDirection = 1;
                this.yDirection = 1;
            }
            drawCircle(){
                //画圆圈(x, y, radius, startAngle, EndAngle)
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
                ctx.stroke();
                ctx.fillStyle = "yellow";
                ctx.fill();
            }
            move(speed){
                //碰到边界就改变方向
                if (this.x === canvasWidth - this.radius){
                    this.xDirection = -1;
                } else if (this.x === this.radius) {
                    this.xDirection = 1;
                }
                if (this.y === canvasHeight - this.radius){
                    this.yDirection = -1;
                } else if (this.y === this.radius) {
                    this.yDirection = 1;
                }

                this.x += this.xDirection * speed;
                this.y += this.yDirection * speed;

            }
        }

        class Plank{
            constructor() {
                this.x = 450;
                this.y = 500;
                this.width = 150;
                this.height = 5;
                this.bindMove = this.move.bind(this);
            }
            drawPlank(){
                ctx.fillStyle = "orange";
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }

            move(env){
                this.x = env.clientX;
                // 以下是用keydown事件来左右移动滑板的做法
                // if (env.key === "ArrowLeft"){
                //    // console.log(this)
                //     this.x -= 50;
                //     if (this.x <= 0){
                //         this.x = 0;
                //     }
                // } else if (env.key === "ArrowRight"){
                //     this.x += 50;
                //     if (this.x >= canvasWidth - this.width){
                //         this.x = canvasWidth - this.width;
                //     }
                // }
            }
            touchingBall(ball){
                return (
                    ball.x + ball.radius >= this.x &&
                    ball.x - ball.radius <= this.x + this.width &&
                    ball.y + ball.radius >= this.y &&
                    ball.y - ball.radius <= this.y
                )
            }
        }
        let brickArray = [];
        class Brick {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 50;
                this.height = 50;
                brickArray.push(this);
            }
            drawBrick(){
                ctx.fillStyle = "lightgreen";
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }

            touchingBall(ball){
                return (
                    ball.x >= this.x - ball.radius &&
                    ball.x <= this.x + this.width + ball.radius &&
                    ball.y <= this.y + this.height + ball.radius &&
                    ball.y >= this.y - ball.radius
                )
            }
        }

        let ball = new Ball();
        let plank = new Plank();

        function getRandomArbitrary(min, max){
            return min + Math.floor(Math.random() * (max - min));
        }

        //随机生成砖块，确保不重叠
        let arr1 = []
        for (let i = 0; i < 10; i++) {

            let x = getRandomArbitrary(0, 950);
            let y = getRandomArbitrary(0, 550);

            for (let j = 0; j < i; j++) {
                let loop = true;
                while (loop){
                    if (
                        x >= arr1[j][0] - 50 &&
                        x <= arr1[j][0] + 50 &&
                        y >= arr1[j][1] - 50 &&
                        y <= arr1[j][1] + 50
                    ){
                        x = getRandomArbitrary(0, 950);
                        y = getRandomArbitrary(0, 550);

                    } else {
                        loop = false;
                    }
                }
            }
            arr1.push([x, y])
            new Brick(arr1[i][0], arr1[i][1])
        }

        window.addEventListener("mousemove", plank.bindMove)
        //此处要传入一个bind方法，否则this会乱跑

        function draw(){
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            //当球碰到板子
            if (plank.touchingBall(ball)) {
                if (ball.yDirection > 0){
                    ball.y -= 40; //碰到板子，球发生弹跳
                } else {
                    ball.y += 40;
                }
                ball.yDirection *= -1;
            }

            //球撞到砖头
            brickArray.forEach((brick, index) => {
               if (brick.touchingBall(ball)){
                   //改变xy，并且移除brick
                   if ((ball.y >= brick.y + brick.height) || (ball.y <= brick.y)){
                       ball.yDirection *= -1;
                   } else {
                       ball.xDirection *= -1;
                   }
                   brickArray.splice(index, 1);//删掉对应的brick
               }
            });

            brickArray.forEach((brick) => {
                brick.drawBrick();
            });

            ball.drawCircle();
            ball.move(20);
            plank.drawPlank();
            if (brickArray.length === 0){
                alert("游戏结束");
                clearInterval(game);
            }
        }
        let game = setInterval(draw, 25)

    </script>
</body>
</html>